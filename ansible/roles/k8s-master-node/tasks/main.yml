---
# tasks file for k8s-master-node

# https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart

- name: Initialize the cluster and check execution
  ansible.builtin.command: sudo kubeadm init --pod-network-cidr=192.168.0.0/16
  args:
    chdir: $HOME
  register: kubeadm_init_result
  changed_when: kubeadm_init_result.rc!= 0

- name: Create .kube directory
  become_user: vagrant
  ansible.builtin.file:
    path: $HOME/.kube
    state: directory
    mode: "0755"
    owner: vagrant
    group: vagrant

- name: Copy admin.conf to user's kube config
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/vagrant/.kube/config
    remote_src: true
    owner: vagrant
    group: vagrant
    mode: "0644"

- name: Install Tigera Calico operator
  become_user: vagrant
  ansible.builtin.command: kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.3/manifests/tigera-operator.yaml
  args:
    chdir: $HOME
    creates: tigera_operator_setup.txt
  register: tigera_operator_result

- name: Wait for a bit before installing Calico custom resource
  ansible.builtin.pause:
    minutes: 3
  when: tigera_operator_result is succeeded

- name: Install Calico from custom resource
  become_user: vagrant
  ansible.builtin.command: kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.3/manifests/custom-resources.yaml
  args:
    chdir: $HOME
  when: tigera_operator_result is succeeded
  register: calico_custom_resource_result

- name: Wait for a bit before installing Calico custom resource
  ansible.builtin.pause:
    minutes: 3
  when: tigera_operator_result is succeeded
